<!DOCTYPE html>


<script>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init('phc_OsZHF9H7fUX08AyjtqACUFVfnsQNWfKYkDy9tl0i0bG',{api_host:'https://app.posthog.com'})
</script>



<html lang="en">
<link rel="stylesheet" href="https://antoniosbarotsis.github.io/index.css">

<head>
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js" integrity="sha512-LQNxIMR5rXv7o+b1l8+N1EZMfhG7iFZ9HhnbJkTp4zjNr5Wvst75AqUeFDxeRUa7l5vEDyUiAip//r+EFLLCyA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/mathtex-script-type.min.js" integrity="sha512-MBhOGY4yRA2eATtRGTcrDJCRqcnLai5+uu47GA2ueVr1MPzirC/iogLWRA8CXTlOTK09VI4fdTe4qE4LBfjsHw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js" integrity="sha512-iWiuBS5nt6r60fCz26Nd0Zqe0nbk1ZTIQbl3Kv7kYsX+yKMUFHzjaH2+AnM6vp2Xs+gNmaBAVWJjSmuPw76Efg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->

    <title>C# and the ELK stack</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>

    <link rel="stylesheet" href="https://antoniosbarotsis.github.io/style.css">
    <link rel="stylesheet" href="https://antoniosbarotsis.github.io/color/orange-auto.css">

        <link rel="stylesheet" href="https://antoniosbarotsis.github.io/color/background_orange.css">
    
    <link rel="stylesheet" href="https://antoniosbarotsis.github.io/font-hack-subset.css">

    
    <meta name="description" content="Integrating the ELK stack with C#.">

    <meta property="og:description" content="Integrating the ELK stack with C#.">
    <meta property="og:title" content="C# and the ELK stack">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://antoniosbarotsis.github.io/posts/cs_elk/">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="Integrating the ELK stack with C#.">
    <meta name="twitter:title" content="C# and the ELK stack">
    <meta property="twitter:domain" content="antoniosbarotsis.github.io">
    <meta property="twitter:url" content="https://antoniosbarotsis.github.io/posts/cs_elk/">

        <link rel="shortcut icon" type="image&#x2F;x-icon" href="/favicon.ico">
    
    </head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://antoniosbarotsis.github.io" style="text-decoration: none;">
                    <div class="logo">
                      
                            Tony&#x27;s Blog
                        
                    </div>
                </a>
            </div>
        </div>

        
        <nav class="menu">
            <ul class="menu__inner">
                <li><a href="https://antoniosbarotsis.github.io">Home</a></li>
            
                <li class="active"><a href="https://antoniosbarotsis.github.io/posts">Posts</a></li>
            
                <li><a href="https://antoniosbarotsis.github.io/tags">Tags</a></li>
            
                <li><a href="https://antoniosbarotsis.github.io/about">About</a></li>
            
                <li><a href="https://github.com/AntoniosBarotsis" target="_blank" rel="noopener noreferrer">Github</a></li>
            
                <li><a href="https://twitter.com/Tony_Barotsis" target="_blank" rel="noopener noreferrer">Twitter</a></li>
            
                <li><a href="https://www.linkedin.com/in/antonios-barotsis-5a26a0199/" target="_blank" rel="noopener noreferrer">LinkedIn</a></li>
            
                <li><a href="mailto:antonios.barotsis@proton.me" target="_blank" rel="noopener noreferrer">Email</a></li>
            </ul>
        </nav>
    
    
        
    </header>
    

    <div class="content">
        
    <div class="post">
        
<h1 class="post-title"><a href="https://antoniosbarotsis.github.io/posts/cs_elk/">C# and the ELK stack</a></h1>
<div class="post-meta-inline">
    
    
<span class="post-date">
    2021-10-28
    </span>
 :: 6 min read ::
    
    


<a href="https://github.com/AntoniosBarotsis/antoniosbarotsis.github.io/blob/master/content/posts/cs_elk.md">View
    Source</a>


&nbsp;
</div>


<span class="post-tags-inline">
    <a class="post-tag" href="https://antoniosbarotsis.github.io/tags/coding/">#Coding</a>,
    <a class="post-tag" href="https://antoniosbarotsis.github.io/tags/csharp/">#Csharp</a></span>


        

<meta name="keywords" content="Antonios,Barotsis,Tony,Portfolio,Blog,Open,Source,Rust" />


<!-- /posts -->
<div class="post-content">
    

<h2>Table of Contents</h2>
<ul>
    
    <li>
        <a href="https://antoniosbarotsis.github.io/posts/cs_elk/#what-is-the-elk-stack">What is the ELK stack?</a>
        
    </li>
    
    <li>
        <a href="https://antoniosbarotsis.github.io/posts/cs_elk/#what-will-we-be-creating">What will we be creating?</a>
        
    </li>
    
    <li>
        <a href="https://antoniosbarotsis.github.io/posts/cs_elk/#coding">Coding</a>
        
        <ul>
            
            <li>
                <a href="https://antoniosbarotsis.github.io/posts/cs_elk/#setting-up-middleware">Setting up middleware</a>
            </li>
            
            <li>
                <a href="https://antoniosbarotsis.github.io/posts/cs_elk/#setting-up-the-elasticsearch-and-kibana-containers">Setting up the Elasticsearch and Kibana containers</a>
            </li>
            
            <li>
                <a href="https://antoniosbarotsis.github.io/posts/cs_elk/#setting-up-serilog">Setting up Serilog</a>
            </li>
            
            <li>
                <a href="https://antoniosbarotsis.github.io/posts/cs_elk/#kibana">Kibana</a>
            </li>
            
        </ul>
        
    </li>
    
    <li>
        <a href="https://antoniosbarotsis.github.io/posts/cs_elk/#conclusion">Conclusion</a>
        
    </li>
    
</ul>


    <h2 id="what-is-the-elk-stack"><a class="anchor" href="#what-is-the-elk-stack" aria-label="Anchor link for: what-is-the-elk-stack">What is the ELK stack?</a></h2>
<p>With today's applications growing in complexity rapidly, debugging and efficiently digesting logs have become crucial.
That is the problem that the <a href="https://www.elastic.co/what-is/elk-stack">ELK stack</a> is trying to solve.</p>
<p>The ELK stack consists of:</p>
<ul>
<li>Elasticsearch: A distributed search engine with highly refined analytics capabilities</li>
<li>Logstash: A data-processing pipeline that collects data and delivers it to Elasticsearch</li>
<li>Kibana: A visualization platform built expressly for Elasticsearch</li>
</ul>
<p>These three together make for a great way of digesting aggregated logs from your application through visualizations.</p>
<h2 id="what-will-we-be-creating"><a class="anchor" href="#what-will-we-be-creating" aria-label="Anchor link for: what-will-we-be-creating">What will we be creating?</a></h2>
<p>We will be making a simple API (the default weather forecast template), have it produce logs using Serilog into elasticsearch and viewing them
through kibana.</p>
<p>For this post I will be assuming you have used C## before and thus you have a ready-to-go set up on your machine.</p>
<h2 id="coding"><a class="anchor" href="#coding" aria-label="Anchor link for: coding">Coding</a></h2>
<p>Let's first make our project using the dotnet cli, I will name mine <code>elk</code></p>
<pre data-lang="bash" style="background-color:#0f1419;color:#bfbab0;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb454;">dotnet</span><span> new webapi</span><span style="color:#f29718;"> -n</span><span> elk
</span></code></pre>
<p>Verify that everything is working fine by running the API</p>
<pre data-lang="bash" style="background-color:#0f1419;color:#bfbab0;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb454;">dotnet</span><span> run
</span></code></pre>
<p>and visiting <code>https://localhost:5001/weatherforecast</code>. I am using <a href="https://insomnia.rest/">Insomnia</a> for my http client but Postman or your browser
would also work.</p>

  
  
    
    
  
  
  <img 
    src="https://antoniosbarotsis.github.io/img/cs_elk/helloWorld.jpg" 
     
    class="center "
    loading="lazy" />
  

<h3 id="setting-up-middleware"><a class="anchor" href="#setting-up-middleware" aria-label="Anchor link for: setting-up-middleware">Setting up middleware</a></h3>
<p>I will be setting up middleware to handle logging as it is a cleaner solution than logging in each request. You can read more about middleware
<a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/write?view=aspnetcore-5.0">here</a>.</p>
<p>I created the following file:</p>
<pre data-lang="cs" style="background-color:#0f1419;color:#bfbab0;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="font-style:italic;color:#5c6773;">// MyMiddleware.cs
</span><span style="color:#ff7733;">using </span><span>System</span><span style="color:#bfbab0cc;">.</span><span>Threading</span><span style="color:#bfbab0cc;">.</span><span>Tasks</span><span style="color:#bfbab0cc;">;
</span><span style="color:#ff7733;">using </span><span>Microsoft</span><span style="color:#bfbab0cc;">.</span><span>AspNetCore</span><span style="color:#bfbab0cc;">.</span><span>Http</span><span style="color:#bfbab0cc;">;
</span><span style="color:#ff7733;">using </span><span>Microsoft</span><span style="color:#bfbab0cc;">.</span><span>Extensions</span><span style="color:#bfbab0cc;">.</span><span>Logging</span><span style="color:#bfbab0cc;">;
</span><span>
</span><span style="color:#ff7733;">namespace </span><span style="color:#59c2ff;">elk
</span><span>{
</span><span>    </span><span style="color:#ff7733;">public class </span><span style="color:#59c2ff;">MyMiddleware
</span><span>    {
</span><span>        </span><span style="color:#ff7733;">private readonly </span><span style="font-style:italic;color:#39bae6;">ILogger</span><span>&lt;</span><span style="font-style:italic;color:#39bae6;">MyMiddleware</span><span>&gt; _logger</span><span style="color:#bfbab0cc;">;
</span><span>        </span><span style="color:#ff7733;">private readonly </span><span style="font-style:italic;color:#39bae6;">RequestDelegate </span><span>_next</span><span style="color:#bfbab0cc;">;
</span><span>
</span><span>        </span><span style="color:#ff7733;">public </span><span style="color:#ffb454;">MyMiddleware</span><span>(</span><span style="font-style:italic;color:#39bae6;">RequestDelegate </span><span style="color:#f29718;">next</span><span style="color:#bfbab0cc;">, </span><span style="font-style:italic;color:#39bae6;">ILogger</span><span>&lt;</span><span style="font-style:italic;color:#39bae6;">MyMiddleware</span><span>&gt; </span><span style="color:#f29718;">logger</span><span>)
</span><span>        {
</span><span>            _next </span><span style="color:#f29668;">= </span><span>next</span><span style="color:#bfbab0cc;">;
</span><span>            _logger </span><span style="color:#f29668;">= </span><span>logger</span><span style="color:#bfbab0cc;">;
</span><span>        }
</span><span>
</span><span>        </span><span style="color:#ff7733;">public async </span><span style="font-style:italic;color:#39bae6;">Task </span><span style="color:#ffb454;">InvokeAsync</span><span>(</span><span style="font-style:italic;color:#39bae6;">HttpContext </span><span style="color:#f29718;">context</span><span>)
</span><span>        {
</span><span>            _logger</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">LogInformation</span><span>(</span><span style="color:#c2d94c;">&quot;Hello from middleware&quot;</span><span>)</span><span style="color:#bfbab0cc;">;
</span><span>            </span><span style="color:#ff7733;">await </span><span style="color:#ffb454;">_next</span><span>(context)</span><span style="color:#bfbab0cc;">;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre>
<p>and added the following line to the <code>Configure</code> method in <code>Startup.cs</code></p>
<pre data-lang="cs" style="background-color:#0f1419;color:#bfbab0;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="font-style:italic;color:#5c6773;">// Startup.cs -&gt; Configure
</span><span>app</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">UseMiddleware</span><span>&lt;</span><span style="font-style:italic;color:#39bae6;">MyMiddleware</span><span>&gt;()</span><span style="color:#bfbab0cc;">;
</span></code></pre>
<p>If we now run the app and make a request to our endpoint we can see <code>Hello from middleware</code> logged to the console.</p>
<p>Knowing that that works lets change the middleware a bit so it can catch and handle exceptions</p>
<pre data-lang="cs" style="background-color:#0f1419;color:#bfbab0;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="font-style:italic;color:#5c6773;">// MyMiddleware.cs
</span><span style="color:#ff7733;">using </span><span>System</span><span style="color:#bfbab0cc;">;
</span><span style="color:#ff7733;">using </span><span>System</span><span style="color:#bfbab0cc;">.</span><span>Threading</span><span style="color:#bfbab0cc;">.</span><span>Tasks</span><span style="color:#bfbab0cc;">;
</span><span style="color:#ff7733;">using </span><span>Microsoft</span><span style="color:#bfbab0cc;">.</span><span>AspNetCore</span><span style="color:#bfbab0cc;">.</span><span>Http</span><span style="color:#bfbab0cc;">;
</span><span style="color:#ff7733;">using </span><span>Microsoft</span><span style="color:#bfbab0cc;">.</span><span>AspNetCore</span><span style="color:#bfbab0cc;">.</span><span>Mvc</span><span style="color:#bfbab0cc;">;
</span><span style="color:#ff7733;">using </span><span>Microsoft</span><span style="color:#bfbab0cc;">.</span><span>Extensions</span><span style="color:#bfbab0cc;">.</span><span>Logging</span><span style="color:#bfbab0cc;">;
</span><span>
</span><span style="color:#ff7733;">namespace </span><span style="color:#59c2ff;">elk
</span><span>{
</span><span>    </span><span style="color:#ff7733;">public class </span><span style="color:#59c2ff;">MyMiddleware
</span><span>    {
</span><span>        </span><span style="color:#ff7733;">private readonly </span><span style="font-style:italic;color:#39bae6;">ILogger</span><span>&lt;</span><span style="font-style:italic;color:#39bae6;">MyMiddleware</span><span>&gt; _logger</span><span style="color:#bfbab0cc;">;
</span><span>        </span><span style="color:#ff7733;">private readonly </span><span style="font-style:italic;color:#39bae6;">RequestDelegate </span><span>_next</span><span style="color:#bfbab0cc;">;
</span><span>
</span><span>        </span><span style="color:#ff7733;">public </span><span style="color:#ffb454;">MyMiddleware</span><span>(</span><span style="font-style:italic;color:#39bae6;">RequestDelegate </span><span style="color:#f29718;">next</span><span style="color:#bfbab0cc;">, </span><span style="font-style:italic;color:#39bae6;">ILogger</span><span>&lt;</span><span style="font-style:italic;color:#39bae6;">MyMiddleware</span><span>&gt; </span><span style="color:#f29718;">logger</span><span>)
</span><span>        {
</span><span>            _next </span><span style="color:#f29668;">= </span><span>next</span><span style="color:#bfbab0cc;">;
</span><span>            _logger </span><span style="color:#f29668;">= </span><span>logger</span><span style="color:#bfbab0cc;">;
</span><span>        }
</span><span>
</span><span>        </span><span style="color:#ff7733;">public async </span><span style="font-style:italic;color:#39bae6;">Task </span><span style="color:#ffb454;">InvokeAsync</span><span>(</span><span style="font-style:italic;color:#39bae6;">HttpContext </span><span style="color:#f29718;">context</span><span>)
</span><span>        {
</span><span>            </span><span style="color:#ff7733;">try
</span><span>            {
</span><span>                </span><span style="color:#ff7733;">await </span><span style="color:#ffb454;">_next</span><span>(context)</span><span style="color:#bfbab0cc;">;
</span><span>            }
</span><span>            </span><span style="color:#ff7733;">catch </span><span>(</span><span style="font-style:italic;color:#39bae6;">Exception </span><span>exception)
</span><span>            {
</span><span>                _logger</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">LogError</span><span>(exception</span><span style="color:#bfbab0cc;">, </span><span style="color:#c2d94c;">&quot;Something went wrong&quot;</span><span>)</span><span style="color:#bfbab0cc;">;
</span><span>                
</span><span>                </span><span style="color:#ff7733;">await </span><span style="color:#ffb454;">HandleExceptionAsync</span><span>(context</span><span style="color:#bfbab0cc;">, </span><span>exception)</span><span style="color:#bfbab0cc;">;
</span><span>            }
</span><span>        }
</span><span>
</span><span>        </span><span style="color:#ff7733;">private static </span><span style="font-style:italic;color:#39bae6;">Task </span><span style="color:#ffb454;">HandleExceptionAsync</span><span>(</span><span style="font-style:italic;color:#39bae6;">HttpContext </span><span style="color:#f29718;">context</span><span style="color:#bfbab0cc;">, </span><span style="font-style:italic;color:#39bae6;">Exception </span><span style="color:#f29718;">ex</span><span>)
</span><span>        {
</span><span>            context</span><span style="color:#f29668;">.</span><span>Response</span><span style="color:#f29668;">.</span><span>StatusCode </span><span style="color:#f29668;">= </span><span style="color:#f29718;">500</span><span style="color:#bfbab0cc;">;
</span><span>            </span><span style="color:#ff7733;">return </span><span>context</span><span style="color:#f29668;">.</span><span>Response</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">WriteAsync</span><span>(</span><span style="color:#c2d94c;">&quot;An exception occurred&quot;</span><span>)</span><span style="color:#bfbab0cc;">;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre>
<p>If we now run the app again we should see nothing logged in the console. If we add a <code>throw new Exception();</code> statement in our controller
we should get a <code>500</code> Response back saying that an exception occurred and also see the exception logged in the terminal.</p>
<p>I am going to add the following to the controller so we get errors at random from the endpoint</p>
<pre data-lang="cs" style="background-color:#0f1419;color:#bfbab0;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#ff7733;">if </span><span>(rng</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">Next</span><span>(</span><span style="color:#f29718;">0</span><span style="color:#bfbab0cc;">, </span><span style="color:#f29718;">10</span><span>) </span><span style="color:#f29668;">&lt; </span><span style="color:#f29718;">2</span><span>)
</span><span>    </span><span style="color:#ff7733;">throw </span><span style="color:#f29668;">new </span><span style="font-style:italic;color:#39bae6;">Exception</span><span>()</span><span style="color:#bfbab0cc;">;
</span></code></pre>
<h3 id="setting-up-the-elasticsearch-and-kibana-containers"><a class="anchor" href="#setting-up-the-elasticsearch-and-kibana-containers" aria-label="Anchor link for: setting-up-the-elasticsearch-and-kibana-containers">Setting up the Elasticsearch and Kibana containers</a></h3>
<p>I will be using Docker to run Elasticsearch and Kibana so first thing I want to do is make a <code>docker-compose.yml</code> file.</p>
<pre data-lang="yml" style="background-color:#0f1419;color:#bfbab0;" class="language-yml "><code class="language-yml" data-lang="yml"><span style="font-style:italic;color:#5c6773;">## docker-compose.yml
</span><span style="color:#59c2ff;">version</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">&quot;2.4&quot;
</span><span style="color:#59c2ff;">services</span><span style="color:#bfbab0cc;">:
</span><span>  </span><span style="color:#59c2ff;">es</span><span style="color:#bfbab0cc;">:
</span><span>    </span><span style="color:#59c2ff;">image</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">docker.elastic.co/elasticsearch/elasticsearch:7.14.2
</span><span>    </span><span style="color:#59c2ff;">container_name</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">es
</span><span>    </span><span style="color:#59c2ff;">ports</span><span style="color:#bfbab0cc;">:
</span><span>      - </span><span style="color:#c2d94c;">&quot;9200:9200&quot;
</span><span>    </span><span style="color:#59c2ff;">cpu_count</span><span style="color:#bfbab0cc;">: </span><span style="color:#f29718;">1
</span><span>    </span><span style="color:#59c2ff;">mem_limit</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">4g
</span><span>    </span><span style="color:#59c2ff;">ulimits</span><span style="color:#bfbab0cc;">:
</span><span>      </span><span style="color:#59c2ff;">memlock</span><span style="color:#bfbab0cc;">:
</span><span>        </span><span style="color:#59c2ff;">soft</span><span style="color:#bfbab0cc;">: </span><span style="color:#f29718;">-1
</span><span>        </span><span style="color:#59c2ff;">hard</span><span style="color:#bfbab0cc;">: </span><span style="color:#f29718;">-1
</span><span>      </span><span style="color:#59c2ff;">nofile</span><span style="color:#bfbab0cc;">:
</span><span>        </span><span style="color:#59c2ff;">soft</span><span style="color:#bfbab0cc;">: </span><span style="color:#f29718;">65536
</span><span>        </span><span style="color:#59c2ff;">hard</span><span style="color:#bfbab0cc;">: </span><span style="color:#f29718;">65536
</span><span>    </span><span style="color:#59c2ff;">environment</span><span style="color:#bfbab0cc;">:
</span><span>      - </span><span style="color:#c2d94c;">cluster.name=es-docker
</span><span>      - </span><span style="color:#c2d94c;">cluster.initial_master_nodes=node1
</span><span>      - </span><span style="color:#c2d94c;">node.name=node1
</span><span>      - </span><span style="color:#c2d94c;">bootstrap.memory_lock=true
</span><span>      - </span><span style="color:#c2d94c;">&quot;ES_JAVA_OPTS=-Xms2g -Xmx2g&quot;
</span><span>  </span><span style="color:#59c2ff;">kib</span><span style="color:#bfbab0cc;">:
</span><span>    </span><span style="color:#59c2ff;">image</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">docker.elastic.co/kibana/kibana:7.14.2
</span><span>    </span><span style="color:#59c2ff;">container_name</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">kib
</span><span>    </span><span style="color:#59c2ff;">ports</span><span style="color:#bfbab0cc;">:
</span><span>      - </span><span style="color:#c2d94c;">&quot;5601:5601&quot;
</span><span>    </span><span style="color:#59c2ff;">depends_on</span><span style="color:#bfbab0cc;">:
</span><span>      - </span><span style="color:#c2d94c;">es
</span><span>    </span><span style="color:#59c2ff;">cpu_count</span><span style="color:#bfbab0cc;">: </span><span style="color:#f29718;">1
</span><span>    </span><span style="color:#59c2ff;">mem_limit</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">4g
</span><span>    </span><span style="color:#59c2ff;">environment</span><span style="color:#bfbab0cc;">: 
</span><span>      </span><span style="color:#59c2ff;">ELASTICSEARCH_URL</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">http://es:9200
</span><span>      </span><span style="color:#59c2ff;">ELASTICSEARCH_HOSTS</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">http://es:9200
</span></code></pre>
<p>A few things about this;</p>
<ul>
<li>It seems that at the time of writing this, version 3 does not support resource limits without using swarm hence the downgrade to 2.4
(please use resource limits if you want your computer to be usable)</li>
<li>The <code>cluster.initial_master_nodes</code> and <code>node.name</code> must have the same value as I want to use a one node cluster</li>
<li>The <code>ELASTICSEARCH_URL</code> and <code>ELASTICSEARCH_HOSTS</code> params are needed since by default these will try to find the elasticsearch server at
<code>http://localhost:9200</code>.</li>
</ul>
<h3 id="setting-up-serilog"><a class="anchor" href="#setting-up-serilog" aria-label="Anchor link for: setting-up-serilog">Setting up Serilog</a></h3>
<p>We will be using the <code>Serilog.AspNetCore</code> (for logging), <code>Serilog.Sinks.Elasticsearch</code> (for pushing our logs to elastic) and
<code>Serilog.Enricher.Environment</code> (for adding properties from System.Environment) packages.</p>
<p>Once you have those installed, go to the <code>appsettings.json</code> file, remove the Logging section and add the following:</p>
<pre data-lang="json" style="background-color:#0f1419;color:#bfbab0;" class="language-json "><code class="language-json" data-lang="json"><span style="color:#c2d94c;">&quot;Serilog&quot;</span><span>: {
</span><span>  </span><span style="color:#c2d94c;">&quot;MinimumLevel&quot;</span><span style="color:#bfbab0cc;">: </span><span>{
</span><span>    </span><span style="color:#c2d94c;">&quot;Default&quot;</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">&quot;Information&quot;</span><span style="color:#bfbab0cc;">,
</span><span>    </span><span style="color:#c2d94c;">&quot;Override&quot;</span><span style="color:#bfbab0cc;">: </span><span>{
</span><span>      </span><span style="color:#c2d94c;">&quot;Microsoft&quot;</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">&quot;Information&quot;</span><span style="color:#bfbab0cc;">,
</span><span>      </span><span style="color:#c2d94c;">&quot;System&quot;</span><span style="color:#bfbab0cc;">: </span><span style="color:#c2d94c;">&quot;Warning&quot;
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre>
<p>We need to make some changes in our <code>Program.cs</code> file both for logging in the terminal as well as pushing our logs to Elastic.</p>
<pre data-lang="cs" style="background-color:#0f1419;color:#bfbab0;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="font-style:italic;color:#5c6773;">// Program.cs
</span><span style="color:#ff7733;">public static </span><span style="font-style:italic;color:#39bae6;">IHostBuilder </span><span style="color:#ffb454;">CreateHostBuilder</span><span>(</span><span style="color:#ff7733;">string</span><span>[] </span><span style="color:#f29718;">args</span><span>)
</span><span>{
</span><span>    </span><span style="color:#ff7733;">return </span><span>Host</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">CreateDefaultBuilder</span><span>(args)
</span><span>        </span><span style="color:#f29668;">.</span><span style="color:#ffb454;">UseSerilog</span><span>((</span><span style="color:#f29718;">context</span><span style="color:#bfbab0cc;">, </span><span style="color:#f29718;">configuration</span><span>) </span><span style="color:#ff7733;">=&gt;
</span><span>        {
</span><span>            configuration
</span><span>                </span><span style="color:#f29668;">.</span><span>Enrich</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">FromLogContext</span><span>()
</span><span>                </span><span style="color:#f29668;">.</span><span>Enrich</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">WithMachineName</span><span>()
</span><span>                </span><span style="color:#f29668;">.</span><span>WriteTo</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">Console</span><span>()
</span><span>                </span><span style="color:#f29668;">.</span><span>WriteTo</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">Elasticsearch</span><span>(
</span><span>                    </span><span style="color:#f29668;">new </span><span style="font-style:italic;color:#39bae6;">ElasticsearchSinkOptions</span><span>(</span><span style="color:#f29668;">new </span><span style="font-style:italic;color:#39bae6;">Uri</span><span>(context</span><span style="color:#f29668;">.</span><span>Configuration[</span><span style="color:#c2d94c;">&quot;ElasticConfig:url&quot;</span><span>]))
</span><span>                    {
</span><span>                        IndexFormat </span><span style="color:#f29668;">= </span><span style="color:#c2d94c;">$&quot;</span><span>{System</span><span style="color:#f29668;">.</span><span>Reflection</span><span style="color:#f29668;">.</span><span>Assembly</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">GetExecutingAssembly</span><span>()</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">GetName</span><span>()</span><span style="color:#f29668;">.</span><span>Name}</span><span style="color:#c2d94c;">-&quot; </span><span style="color:#f29668;">+
</span><span>                                      </span><span style="color:#c2d94c;">$&quot;</span><span>{context</span><span style="color:#f29668;">.</span><span>Configuration[</span><span style="color:#c2d94c;">&quot;ASPNETCORE_ENVIRONMENT&quot;</span><span>]</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">ToLower</span><span>()}</span><span style="color:#c2d94c;">_</span><span>{DateTime</span><span style="color:#f29668;">.</span><span>UtcNow</span><span style="color:#bfbab0cc;">:</span><span style="color:#f29718;">yyyy-MM-dd</span><span>}</span><span style="color:#c2d94c;">&quot;</span><span style="color:#bfbab0cc;">,
</span><span>                        AutoRegisterTemplate </span><span style="color:#f29668;">= </span><span style="color:#f29718;">true
</span><span>                    })
</span><span>                </span><span style="color:#f29668;">.</span><span>Enrich</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">WithProperty</span><span>(</span><span style="color:#c2d94c;">&quot;Environment&quot;</span><span style="color:#bfbab0cc;">, </span><span>context</span><span style="color:#f29668;">.</span><span>HostingEnvironment</span><span style="color:#f29668;">.</span><span>EnvironmentName)
</span><span>                </span><span style="color:#f29668;">.</span><span>ReadFrom</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">Configuration</span><span>(context</span><span style="color:#f29668;">.</span><span>Configuration)</span><span style="color:#bfbab0cc;">;
</span><span>        })
</span><span>        </span><span style="color:#f29668;">.</span><span style="color:#ffb454;">ConfigureWebHostDefaults</span><span>(</span><span style="color:#f29718;">webBuilder </span><span style="color:#ff7733;">=&gt; </span><span>{ webBuilder</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">UseStartup</span><span>&lt;</span><span style="font-style:italic;color:#39bae6;">Startup</span><span>&gt;()</span><span style="color:#bfbab0cc;">; </span><span>})</span><span style="color:#bfbab0cc;">;
</span><span>}
</span></code></pre>
<p>Most of this you can find online but for as a short explanation:</p>
<ul>
<li>We enrich our logs with the log context, machine name and the environment (dev/prod)</li>
<li>We push our logs both to the console and to elastic</li>
<li>The logs in elastic will have the format <code>appname-dev/prod_date</code>. Something to keep in mind for this is that it looks like some characters
like <code>:</code> do not work in these patterns or at least didn't work for me hence the underscore.</li>
</ul>
<p>What's cool about this is that we do not have to change our existing logger related code! We can also however use Serilog directly:</p>
<ul>
<li>Change the <code>using Microsoft.Extensions.Logging;</code> import to <code>using Serilog;</code></li>
<li>Remove the generic from the <code>ILogger</code>s</li>
<li>Change <code>_logger.LogError</code> to <code>_logger.Error</code></li>
</ul>
<p>Another thing we can do is edit the Exception data and log some debugging critical parameter.</p>
<pre data-lang="cs" style="background-color:#0f1419;color:#bfbab0;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="font-style:italic;color:#5c6773;">// WeatherForecastController.cs
</span><span style="color:#ff7733;">if </span><span>(rng</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">Next</span><span>(</span><span style="color:#f29718;">0</span><span style="color:#bfbab0cc;">, </span><span style="color:#f29718;">10</span><span>) </span><span style="color:#f29668;">&lt; </span><span style="color:#f29718;">2</span><span>)
</span><span>{
</span><span>    </span><span style="color:#ff7733;">var </span><span>myException </span><span style="color:#f29668;">= new </span><span style="font-style:italic;color:#39bae6;">Exception</span><span>()</span><span style="color:#bfbab0cc;">;
</span><span>    myException</span><span style="color:#f29668;">.</span><span>Data</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">Add</span><span>(</span><span style="color:#c2d94c;">&quot;someVeryImportantAttribute&quot;</span><span style="color:#bfbab0cc;">, </span><span style="color:#f29718;">42</span><span>)</span><span style="color:#bfbab0cc;">;
</span><span>    </span><span style="color:#ff7733;">throw </span><span>myException</span><span style="color:#bfbab0cc;">;
</span><span>}
</span></code></pre>
<pre data-lang="cs" style="background-color:#0f1419;color:#bfbab0;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="font-style:italic;color:#5c6773;">// MyMiddleware.cs
</span><span style="color:#ff3333;">catch </span><span>(Exception exception)
</span><span>{
</span><span>    _logger</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">Error</span><span>(exception</span><span style="color:#bfbab0cc;">, </span><span style="color:#c2d94c;">&quot;Something went wrong, {message}&quot;</span><span style="color:#bfbab0cc;">, </span><span>exception</span><span style="color:#f29668;">.</span><span>Data[</span><span style="color:#c2d94c;">&quot;someVeryImportantAttribute&quot;</span><span>])</span><span style="color:#bfbab0cc;">;
</span><span>    
</span><span>    </span><span style="color:#ff7733;">await </span><span style="color:#ffb454;">HandleExceptionAsync</span><span>(context</span><span style="color:#bfbab0cc;">, </span><span>exception)</span><span style="color:#bfbab0cc;">;
</span><span>}
</span></code></pre>
<p>If we now run the app logs will start getting pushed to elastic (make sure to also make a few requests so you get some errors!).</p>
<h3 id="kibana"><a class="anchor" href="#kibana" aria-label="Anchor link for: kibana">Kibana</a></h3>
<p>We can now visit <code>http://localhost:5601</code> to access kibana.</p>
<p>Once there, go to <code>Spaces &gt; Manage Spaces</code> from the top right and select default. On the left you should see <code>Index patterns</code> and if you go there
you can essentially define the log pattern that you want kibana to consider, in my case that is <code>elk-development_*</code>. We can then go to
<code>Analytics &gt; Discover</code> and voilà!</p>

  
  
    
    
  
  
  <img 
    src="https://antoniosbarotsis.github.io/img/cs_elk/logs.jpg" 
     
    class="center "
    loading="lazy" />
  

<p>If you made the Exception data change mentioned earlier you should be able to see that as well</p>

  
  
    
    
  
  
  <img 
    src="https://antoniosbarotsis.github.io/img/cs_elk/data.jpg" 
     
    class="center "
    loading="lazy" />
  

<p>The true power of this comes from how you can query your logs. You could for example query for <code>level: Error</code> to get all your error logs</p>

  
  
    
    
  
  
  <img 
    src="https://antoniosbarotsis.github.io/img/cs_elk/errors.jpg" 
     
    class="center "
    loading="lazy" />
  

<p>You could also make queries like <code>fields.ElapsedMilliseconds &gt; 10</code> or <code>fields.RequestPath: /weatherforecast</code>, you can read more about the
possible queries <a href="https://www.elastic.co/guide/en/kibana/current/kuery-query.html">here</a>.</p>
<p>One thing I always love spending way too much time on is visualizations and I can definitely see this being the most powerful feature in
Kibana</p>

  
  
    
    
  
  
  <img 
    src="https://antoniosbarotsis.github.io/img/cs_elk/plots.jpg" 
     
    class="center "
    loading="lazy" />
  

<h2 id="conclusion"><a class="anchor" href="#conclusion" aria-label="Anchor link for: conclusion">Conclusion</a></h2>
<p>Overall I think this was a pretty cool learning experience for me as I had never done proper error handling or used middleware before in
C## (or used docker hardware limits but we do not talk about that). I think that although I definitely see the ELK stack being invaluable
to a big company, I feel like I will not be using or recommend others to use if for small or personal projects as it is relatively hard
to set up locally and expensive to host (especially if before this you just had a single app instance running).</p>
<p>Long story short; it is definitely pretty cool but like normal logging should be enough for the majority of cases 👍.</p>
<p>And of course by no means will implementing all of this compensate for bad error handling.</p>
<p>Thanks for reading!</p>
<p>You can find the code <a href="https://github.com/AntoniosBarotsis/elk">here</a>.</p>

</div>

        
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read more</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        <span class="button previous">
            <a href="https://antoniosbarotsis.github.io/posts/aspnet_testing/">
                <span class="button__icon">←</span>&nbsp;
                <span class="button__text">Testing an ASP .NET Core project</span>
            </a>
        </span>
        
        </div>
</div>

<script src="https://utteranc.es/client.js" repo="AntoniosBarotsis/antoniosbarotsis.github.io" issue-term="pathname"
    label="Comment" theme="github-dark" crossorigin="anonymous" async>
    </script>


    </div>


    </div>
    
    
    <footer class="footer">
        <div class="footer__inner">
                <div class="copyright">
                        <span>© 
    2025
 Powered by <a href="https://www.getzola.org/">Zola</a></span>
                    <span class="copyright-theme">
                        <span class="copyright-theme-sep">:: </span>
                        Theme: <a href="https://github.com/pawroman/zola-theme-terminimal/">Terminimal</a> by pawroman
                    </span>
                </div>
            </div>
    </footer>
    

</div>
</body>

</html>
